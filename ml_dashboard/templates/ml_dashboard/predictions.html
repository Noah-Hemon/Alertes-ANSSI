{% extends 'ml_dashboard/base.html' %}

{% block title %}Pr√©dictions ML - Dashboard ANSSI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4>üîÆ Pr√©dictions de Dates de Fin de Menace</h4>
            </div>
            <div class="card-body">
                <button id="runPredictions" class="btn btn-success mb-3">
                    <i class="fas fa-play"></i> Ex√©cuter les Pr√©dictions
                </button>
                <div id="predictionResults">
                    <div class="text-center text-muted">
                        <p>Cliquez sur "Ex√©cuter les Pr√©dictions" pour lancer l'analyse</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4" id="predictionStats" style="display: none;">
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5>Pr√©dictions G√©n√©r√©es</h5>
                <h2 id="predictionsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5>Dur√©e Moyenne</h5>
                <h2 id="avgDuration">0</h2>
                <small>jours</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5>Donn√©es d'Entra√Ænement</h5>
                <h2 id="trainSize">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <h5>√Ä Pr√©dire</h5>
                <h2 id="predSize">0</h2>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('runPredictions').addEventListener('click', function() {
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ex√©cution en cours...';
    this.disabled = true;
    
    fetch('{% url "ml_dashboard:api_predictions" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher les statistiques
                document.getElementById('predictionsCount').textContent = data.predictions_count;
                document.getElementById('avgDuration').textContent = Math.round(data.avg_duration);
                document.getElementById('trainSize').textContent = data.train_size;
                document.getElementById('predSize').textContent = data.pred_size;
                
                document.getElementById('predictionStats').style.display = 'flex';
                
                // Afficher les r√©sultats
                let html = '<div class="alert alert-success"><h5>‚úÖ Pr√©dictions termin√©es avec succ√®s !</h5></div>';
                html += '<div class="row">';
                html += '<div class="col-md-6">';
                html += '<h6>üìä R√©sum√© des Pr√©dictions</h6>';
                html += '<ul class="list-group">';
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>Pr√©dictions g√©n√©r√©es</span>
                    <span class="badge bg-primary">${data.predictions_count}</span>
                </li>`;
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>Dur√©e moyenne pr√©dite</span>
                    <span class="badge bg-success">${Math.round(data.avg_duration)} jours</span>
                </li>`;
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>Donn√©es d'entra√Ænement</span>
                    <span class="badge bg-info">${data.train_size}</span>
                </li>`;
                html += '</ul>';
                html += '</div>';
                
                // Afficher la distribution des dur√©es si disponible
                if (data.durations && data.durations.length > 0) {
                    html += '<div class="col-md-6">';
                    html += '<h6>üìà Distribution des Dur√©es Pr√©dites</h6>';
                    
                    // Calculer les statistiques
                    const durations = data.durations;
                    const min = Math.min(...durations);
                    const max = Math.max(...durations);
                    const median = durations.sort((a, b) => a - b)[Math.floor(durations.length / 2)];
                    
                    html += '<ul class="list-group">';
                    html += `<li class="list-group-item d-flex justify-content-between">
                        <span>Dur√©e minimale</span>
                        <span class="badge bg-secondary">${min} jours</span>
                    </li>`;
                    html += `<li class="list-group-item d-flex justify-content-between">
                        <span>Dur√©e maximale</span>
                        <span class="badge bg-secondary">${max} jours</span>
                    </li>`;
                    html += `<li class="list-group-item d-flex justify-content-between">
                        <span>Dur√©e m√©diane</span>
                        <span class="badge bg-secondary">${median} jours</span>
                    </li>`;
                    html += '</ul>';
                    html += '</div>';
                }
                
                html += '</div>';
                
                document.getElementById('predictionResults').innerHTML = html;
            } else {
                document.getElementById('predictionResults').innerHTML = 
                    `<div class="alert alert-danger">‚ùå Erreur: ${data.error}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('predictionResults').innerHTML = 
                `<div class="alert alert-danger">‚ùå Erreur de connexion: ${error}</div>`;
        })
        .finally(() => {
            document.getElementById('runPredictions').innerHTML = '<i class="fas fa-play"></i> Ex√©cuter les Pr√©dictions';
            document.getElementById('runPredictions').disabled = false;
        });
});
</script>
{% endblock %}